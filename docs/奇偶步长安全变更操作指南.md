# 奇偶步长安全变更操作指南

## 概述

本文档详细说明如何安全地变更分布式ID生成器的奇偶步长配置，确保在变更过程中系统的稳定性和数据一致性。

## 兼容性状态

✅ **系统已完全兼容步长变更**

经过代码修复，当前系统已经支持安全的步长变更操作，包括：
- 自动检测步长变化
- 原子性更新数据库
- 缓存同步机制
- 并发安全保障

## 变更方式

### 1. 配置文件变更（影响新业务）

#### 1.1 修改默认步长
```yaml
# application.yml
id:
  generator:
    step:
      size: 2000  # 从1000变更为2000
```

#### 1.2 环境变量方式
```bash
export ID_STEP_SIZE=2000
```

**影响范围**：仅影响新创建的业务类型和时间键

### 2. API接口变更（影响现有业务）

#### 2.1 预览变更影响
```bash
# 预览指定业务类型的变更影响
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&newStepSize=2000&preview=true"

# 预览指定业务类型和时间键的变更影响
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&timeKey=20231201&newStepSize=2000&preview=true"
```

#### 2.2 执行步长变更
```bash
# 变更指定业务类型的所有号段
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&newStepSize=2000&preview=false"

# 变更指定业务类型和时间键的号段
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&timeKey=20231201&newStepSize=2000&preview=false"
```

#### 2.3 查询当前步长配置
```bash
# 查询所有业务类型的步长统计
curl "http://localhost:8080/admin/step-size/current"

# 查询指定业务类型的详细步长信息
curl "http://localhost:8080/admin/step-size/current?businessType=order"
```

### 3. 请求级变更（临时使用）

```bash
# 在ID生成请求中指定自定义步长
curl -X POST "http://localhost:8080/api/ids/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "businessType": "order",
    "count": 10,
    "customStepSize": 2000
  }'
```

## 安全变更流程

### 步骤1：评估影响范围

1. **查询当前配置**
```bash
curl "http://localhost:8080/admin/step-size/current"
```

2. **预览变更影响**
```bash
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&newStepSize=2000&preview=true"
```

### 步骤2：选择变更时机

- **低峰期执行**：选择业务低峰期进行变更
- **分批变更**：对于大量号段，建议按时间键分批变更
- **监控准备**：确保监控系统正常，能及时发现异常

### 步骤3：执行变更

1. **单个业务类型变更**
```bash
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&newStepSize=2000&preview=false"
```

2. **验证变更结果**
```bash
curl "http://localhost:8080/admin/step-size/current?businessType=order"
```

3. **测试ID生成**
```bash
curl -X POST "http://localhost:8080/api/ids/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "businessType": "order",
    "count": 5
  }'
```

### 步骤4：监控验证

1. **检查日志**：观察是否有步长变更相关的日志
2. **性能监控**：确认ID生成性能正常
3. **数据一致性**：验证生成的ID符合奇偶性要求

## 变更响应示例

### 预览响应
```json
{
  "success": true,
  "preview": true,
  "businessType": "order",
  "newStepSize": 2000,
  "totalSegments": 4,
  "changedCount": 2,
  "skippedCount": 2,
  "message": "预览完成：将影响 4 个号段，其中 2 个需要变更，2 个无需变更",
  "affectedSegments": [
    {
      "businessType": "order",
      "timeKey": "20231201",
      "shardType": 0,
      "currentStepSize": 1000,
      "newStepSize": 2000,
      "action": "WILL_UPDATE",
      "changed": true
    }
  ]
}
```

### 执行响应
```json
{
  "success": true,
  "preview": false,
  "businessType": "order",
  "newStepSize": 2000,
  "totalSegments": 4,
  "changedCount": 2,
  "skippedCount": 2,
  "message": "变更完成：共处理 4 个号段，其中 2 个已变更，2 个无需变更"
}
```

## 注意事项

### 1. 步长选择原则

- **业务QPS考虑**：高QPS业务使用较大步长（减少数据库访问）
- **ID浪费控制**：低QPS业务使用较小步长（减少ID浪费）
- **奇偶性保持**：步长变更不影响ID的奇偶性分配

### 2. 变更时机建议

- **避免高峰期**：在业务低峰期执行变更操作
- **分批执行**：对于大量号段，建议分批次变更
- **预留回滚**：准备回滚方案，必要时可快速恢复

### 3. 监控要点

- **ID生成延迟**：监控ID生成的响应时间
- **数据库连接**：关注数据库连接池状态
- **缓存命中率**：观察号段缓存的命中情况
- **错误日志**：及时发现和处理异常

### 4. 回滚方案

如果变更后出现问题，可以通过以下方式回滚：

```bash
# 回滚到原步长
curl -X POST "http://localhost:8080/admin/step-size/change" \
  -d "businessType=order&newStepSize=1000&preview=false"
```

## 技术实现细节

### 1. 步长变更检测
- 系统自动检测数据库中的步长与请求步长是否一致
- 只有在步长确实发生变化时才执行更新操作

### 2. 原子性保证
- 使用数据库事务确保步长和最大值的原子性更新
- 避免并发更新导致的数据不一致

### 3. 缓存同步
- 步长变更后自动清理对应的内存缓存
- 下次访问时重新从数据库加载最新配置

### 4. 并发安全
- 使用分布式锁机制避免并发变更冲突
- 确保同一号段的变更操作串行执行

## 常见问题

### Q1: 步长变更会影响ID的连续性吗？
A: 不会。步长变更只影响号段的大小，不影响ID的连续性和奇偶性分配。

### Q2: 可以在运行时动态变更步长吗？
A: 可以。系统支持运行时动态变更，无需重启服务。

### Q3: 步长变更会导致ID重复吗？
A: 不会。系统使用原子性更新机制，确保ID的唯一性。

### Q4: 如何选择合适的步长？
A: 建议根据业务QPS选择：
- 高QPS（>1000/s）：步长2000-5000
- 中QPS（100-1000/s）：步长1000-2000  
- 低QPS（<100/s）：步长500-1000

## 总结

当前系统已完全支持安全的奇偶步长变更，通过API接口可以灵活地管理步长配置。建议在变更前充分测试，在低峰期执行，并做好监控和回滚准备。