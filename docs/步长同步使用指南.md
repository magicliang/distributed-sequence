# 步长同步使用指南

## 概述

本文档介绍如何使用分布式ID生成器的**步长同步功能**，该功能可以强制所有服务器使用相同的新步长，确保系统的一致性和性能优化。

## 核心功能

### 1. 强制全局步长同步

**功能描述**：强制所有服务器使用相同的新步长，更新数据库中所有相关号段的步长，并清理所有服务器的内存缓存。

**API接口**：
```http
POST /api/id/admin/step-size/force-sync
```

**参数说明**：
- `businessType`（可选）：业务类型，不指定则更新所有业务类型
- `newStepSize`（必需）：新的步长值，必须大于0
- `preview`（可选）：是否仅预览影响范围，默认false

**使用示例**：

```bash
# 1. 预览模式：查看将要影响的号段数量
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=order&newStepSize=2000&preview=true"

# 返回示例：
{
  "success": true,
  "preview": true,
  "businessType": "order",
  "newStepSize": 2000,
  "updatedCount": 4,
  "timestamp": 1703234567890,
  "message": "预览：将强制同步 4 个号段的步长为 2000"
}

# 2. 执行模式：实际执行步长同步
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=order&newStepSize=2000&preview=false"

# 返回示例：
{
  "success": true,
  "preview": false,
  "businessType": "order",
  "newStepSize": 2000,
  "updatedCount": 4,
  "cacheCleared": 15,
  "timestamp": 1703234567890,
  "message": "强制同步完成：已更新 4 个号段的步长为 2000，并清理了所有内存缓存"
}

# 3. 全局同步：更新所有业务类型的步长
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "newStepSize=1500&preview=false"
```

### 2. 步长一致性检查

**功能描述**：检查指定业务类型下所有分片是否使用相同的步长。

**API接口**：
```http
GET /api/id/admin/step-size/consistency-check
```

**参数说明**：
- `businessType`（必需）：要检查的业务类型

**使用示例**：

```bash
# 检查指定业务类型的步长一致性
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=order"

# 返回示例（一致）：
{
  "success": true,
  "businessType": "order",
  "isConsistent": true,
  "distinctStepSizeCount": 1,
  "totalShards": 2,
  "commonStepSize": 1000,
  "shardDetails": [
    {"shardType": 0, "stepSize": 1000},
    {"shardType": 1, "stepSize": 1000}
  ],
  "timestamp": 1703234567890,
  "message": "步长一致：所有 2 个分片都使用步长 1000"
}

# 返回示例（不一致）：
{
  "success": true,
  "businessType": "order",
  "isConsistent": false,
  "distinctStepSizeCount": 2,
  "totalShards": 2,
  "shardDetails": [
    {"shardType": 0, "stepSize": 1000},
    {"shardType": 1, "stepSize": 2000}
  ],
  "timestamp": 1703234567890,
  "message": "步长不一致：2 个分片使用了 2 种不同的步长"
}
```

### 3. 全局步长一致性报告

**功能描述**：检查所有业务类型的步长一致性状况。

**API接口**：
```http
GET /api/id/admin/step-size/global-consistency-report
```

**使用示例**：

```bash
# 获取全局步长一致性报告
curl -X GET "http://localhost:8080/api/id/admin/step-size/global-consistency-report"

# 返回示例：
{
  "success": true,
  "totalBusinessTypes": 3,
  "consistentBusinessTypes": 2,
  "inconsistentBusinessTypes": 1,
  "businessReports": [
    {
      "businessType": "order",
      "isConsistent": true,
      "commonStepSize": 1000,
      "message": "步长一致：所有 2 个分片都使用步长 1000"
    },
    {
      "businessType": "user",
      "isConsistent": false,
      "message": "步长不一致：2 个分片使用了 2 种不同的步长"
    },
    {
      "businessType": "payment",
      "isConsistent": true,
      "commonStepSize": 2000,
      "message": "步长一致：所有 2 个分片都使用步长 2000"
    }
  ],
  "timestamp": 1703234567890,
  "message": "发现步长不一致：3 个业务类型中有 1 个存在步长不一致问题"
}
```

## 使用场景

### 场景1：性能优化

当业务量增长时，需要增大步长以减少数据库访问频率：

```bash
# 1. 先检查当前状态
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=order"

# 2. 预览变更影响
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=order&newStepSize=5000&preview=true"

# 3. 执行变更
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=order&newStepSize=5000&preview=false"

# 4. 验证变更结果
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=order"
```

### 场景2：修复步长不一致问题

当发现某个业务类型的分片使用了不同的步长时：

```bash
# 1. 发现问题
curl -X GET "http://localhost:8080/api/id/admin/step-size/global-consistency-report"

# 2. 检查具体问题
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=problematic_business"

# 3. 强制同步到统一步长
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=problematic_business&newStepSize=2000&preview=false"

# 4. 验证修复结果
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=problematic_business"
```

### 场景3：全局步长标准化

统一所有业务类型的步长：

```bash
# 1. 查看全局状况
curl -X GET "http://localhost:8080/api/id/admin/step-size/global-consistency-report"

# 2. 预览全局变更
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "newStepSize=2000&preview=true"

# 3. 执行全局变更
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "newStepSize=2000&preview=false"

# 4. 验证全局结果
curl -X GET "http://localhost:8080/api/id/admin/step-size/global-consistency-report"
```

## 最佳实践

### 1. 操作前检查

在执行步长变更前，建议先进行以下检查：

```bash
# 检查系统状态
curl -X GET "http://localhost:8080/api/id/status"

# 检查步长一致性
curl -X GET "http://localhost:8080/api/id/admin/step-size/global-consistency-report"

# 预览变更影响
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=target&newStepSize=new_value&preview=true"
```

### 2. 分步执行

对于大规模系统，建议分业务类型逐步执行：

```bash
# 先处理低频业务
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=low_frequency_business&newStepSize=1000&preview=false"

# 再处理高频业务
curl -X POST "http://localhost:8080/api/id/admin/step-size/force-sync" \
  -d "businessType=high_frequency_business&newStepSize=5000&preview=false"
```

### 3. 监控验证

变更后及时验证结果：

```bash
# 验证步长一致性
curl -X GET "http://localhost:8080/api/id/admin/step-size/consistency-check?businessType=changed_business"

# 检查系统状态
curl -X GET "http://localhost:8080/api/id/status"

# 测试ID生成
curl -X GET "http://localhost:8080/api/id/single/changed_business"
```

## 注意事项

### 1. 操作影响

- **内存缓存清理**：强制同步会清理所有内存缓存，短时间内可能增加数据库访问
- **服务器同步**：所有服务器实例都会受到影响，确保在低峰期执行
- **ID跳跃**：步长变更可能导致ID序列出现跳跃，这是正常现象

### 2. 安全建议

- **权限控制**：步长同步是敏感操作，应严格控制访问权限
- **备份数据**：重要操作前建议备份相关数据
- **测试环境验证**：生产环境操作前先在测试环境验证

### 3. 性能考虑

- **步长选择**：根据业务QPS选择合适的步长值
  - 低频业务：500-1000
  - 中频业务：1000-5000  
  - 高频业务：5000-10000
  - 超高频业务：10000+

- **执行时机**：建议在业务低峰期执行步长同步操作

## 故障排除

### 问题1：步长同步失败

**现象**：API返回success=false

**排查步骤**：
1. 检查参数是否正确（步长必须大于0）
2. 检查数据库连接是否正常
3. 检查是否有并发操作冲突
4. 查看服务器日志获取详细错误信息

### 问题2：步长不一致持续存在

**现象**：执行同步后仍然检测到不一致

**排查步骤**：
1. 确认是否有其他服务器实例在并发修改
2. 检查数据库事务是否正确提交
3. 验证缓存是否已正确清理
4. 重启相关服务器实例

### 问题3：性能下降

**现象**：步长变更后系统性能下降

**排查步骤**：
1. 检查新步长是否过小，导致频繁数据库访问
2. 监控数据库连接池使用情况
3. 检查缓存命中率
4. 考虑适当增大步长值

## 总结

步长同步功能提供了强大的运维能力，可以确保分布式环境下所有服务器使用一致的步长配置。通过合理使用这些功能，可以：

1. **保证一致性**：确保所有分片使用相同的步长
2. **优化性能**：根据业务需求动态调整步长
3. **简化运维**：提供完整的检查和同步工具
4. **提高可靠性**：避免因步长不一致导致的问题

建议在使用这些功能时遵循最佳实践，确保系统的稳定性和性能。